/**
 * JustGage - a handy JavaScript plugin for generating and animating nice & clean dashboard gauges.
 * Copyright (c) 2012 Bojan Djuricic - pindjur(at)gmail(dot)com | http://www.madcog.com
 * Licensed under MIT.
 * Date: 31/07/2012
 * @author Bojan Djuricic  (@Toorshia)
 * @version 1.0
 *
 * http://www.justgage.com
 */
 
JustGage=function(config){if(!config.id){alert("Missing id parameter for gauge!");return false;}if(!document.getElementById(config.id)){alert("No element with id: \""+config.id+"\" found!");return false;}this.config={id:config.id,title:(config.title)?config.title:"",fixedProgress:(config.fixedProgress!=null)?config.fixedProgress:false,progressValues:(config.progressValues)?config.progressValues:null,titleFontColor:(config.titleFontColor)?config.titleFontColor:"#999999",value:(config.value)?config.value:0,valueText:(config.valueText)?config.valueText:((config.value)?config.value:0),valueFontColor:(config.valueFontColor)?config.valueFontColor:"#010101",min:(config.min)?config.min:0,max:(config.max)?config.max:100,showMinMax:(config.showMinMax!=null)?config.showMinMax:true,gaugeWidthScale:(config.gaugeWidthScale)?config.gaugeWidthScale:1.0,gaugeColor:(config.gaugeColor)?config.gaugeColor:"#edebeb",label:(config.label)?config.label:"",showInnerShadow:(config.showInnerShadow!=null)?config.showInnerShadow:true,shadowOpacity:(config.shadowOpacity)?config.shadowOpacity:0.2,shadowSize:(config.shadowSize)?config.shadowSize:5,shadowVerticalOffset:(config.shadowVerticalOffset)?config.shadowVerticalOffset:3,levelColors:(config.levelColors)?config.levelColors:percentColors,levelColorsGradient:(config.levelColorsGradient!=null)?config.levelColorsGradient:true,labelFontColor:(config.labelFontColor)?config.labelFontColor:"#b3b3b3",startAnimationTime:(config.startAnimationTime)?config.startAnimationTime:700,startAnimationType:(config.startAnimationType)?config.startAnimationType:">",refreshAnimationTime:(config.refreshAnimationTime)?config.refreshAnimationTime:700,refreshAnimationType:(config.refreshAnimationType)?config.refreshAnimationType:">"};if(config.value>this.config.max)this.config.value=this.config.max;if(config.value<this.config.min)this.config.value=this.config.min;this.originalValue=config.value;this.canvas=Raphael(this.config.id,"100%","100%");var canvasW=getStyle(document.getElementById(this.config.id),"width").slice(0,-2)*1;var canvasH=getStyle(document.getElementById(this.config.id),"height").slice(0,-2)*1;var widgetW,widgetH;if((canvasW/canvasH)>1.25){widgetW=1.25*canvasH;widgetH=canvasH;}else{widgetW=canvasW;widgetH=canvasW/1.25;}var dx=(canvasW-widgetW)/2;var dy=(canvasH-widgetH)/2;var titleFontSize=((widgetH/8)>10)?(widgetH/10):10;var titleX=dx+widgetW/2;var titleY=dy+widgetH/6.5;var valueFontSize=((widgetH/6.4)>16)?(widgetH/6.4):16;var valueX=dx+widgetW/2;var valueY=dy+widgetH/1.4;var labelFontSize=((widgetH/16)>10)?(widgetH/16):10;var labelX=dx+widgetW/2;var labelY=valueY+valueFontSize/2+6;var minFontSize=((widgetH/16)>10)?(widgetH/16):10;var minX=dx+(widgetW/10)+(widgetW/6.666666666666667*this.config.gaugeWidthScale)/2;var minY=dy+widgetH/1.126760563380282;var maxFontSize=((widgetH/16)>10)?(widgetH/16):10;var maxX=dx+widgetW-(widgetW/10)-(widgetW/6.666666666666667*this.config.gaugeWidthScale)/2;var maxY=dy+widgetH/1.126760563380282;this.params={canvasW:canvasW,canvasH:canvasH,widgetW:widgetW,widgetH:widgetH,dx:dx,dy:dy,titleFontSize:titleFontSize,titleX:titleX,titleY:titleY,valueFontSize:valueFontSize,valueX:valueX,valueY:valueY,labelFontSize:labelFontSize,labelX:labelX,labelY:labelY,minFontSize:minFontSize,minX:minX,minY:minY,maxFontSize:maxFontSize,maxX:maxX,maxY:maxY};this.canvas.customAttributes.pki=function(value,min,max,w,h,dx,dy,gws){var alpha=(1-(value-min)/(max-min))*Math.PI,Ro=w/2-w/10,Ri=Ro-w/6.666666666666667*gws,Cx=w/2+dx,Cy=h/1.25+dy,Xo=w/2+dx+Ro*Math.cos(alpha),Yo=h-(h-Cy)+dy-Ro*Math.sin(alpha),Xi=w/2+dx+Ri*Math.cos(alpha),Yi=h-(h-Cy)+dy-Ri*Math.sin(alpha),path;path+="M"+(Cx-Ri)+","+Cy+" ";path+="L"+(Cx-Ro)+","+Cy+" ";path+="A"+Ro+","+Ro+" 0 0,1 "+Xo+","+Yo+" ";path+="L"+Xi+","+Yi+" ";path+="A"+Ri+","+Ri+" 0 0,0 "+(Cx-Ri)+","+Cy+" ";path+="z ";return{path:path};}this.gauge=this.canvas.path().attr({"stroke":"none","fill":this.config.gaugeColor,pki:[this.config.max,this.config.min,this.config.max,this.params.widgetW,this.params.widgetH,this.params.dx,this.params.dy,this.config.gaugeWidthScale]});this.gauge.id=this.config.id+"-gauge";this.level=this.canvas.path().attr({"stroke":"none","fill":getColorForPercentage((this.config.value-this.config.min)/(this.config.max-this.config.min),this.config.levelColors,this.config.levelColorsGradient,this.config.fixedProgress,this.config.progressValues),pki:[this.config.min,this.config.min,this.config.max,this.params.widgetW,this.params.widgetH,this.params.dx,this.params.dy,this.config.gaugeWidthScale]});this.level.id=this.config.id+"-level";this.txtTitle=this.canvas.text(this.params.titleX,this.params.titleY,this.config.title);this.txtTitle.attr({"font-size":this.params.titleFontSize,"font-weight":"bold","font-family":"Arial","fill":this.config.titleFontColor,"fill-opacity":"1"});this.txtTitle.id=this.config.id+"-txttitle";this.txtValue=this.canvas.text(this.params.valueX,this.params.valueY,this.config.valueText);this.txtValue.attr({"font-size":this.params.valueFontSize,"font-weight":"bold","font-family":"Arial","fill":this.config.valueFontColor,"fill-opacity":"0"});this.txtValue.id=this.config.id+"-txtvalue";this.txtLabel=this.canvas.text(this.params.labelX,this.params.labelY,this.config.label);this.txtLabel.attr({"font-size":this.params.labelFontSize,"font-weight":"normal","font-family":"Arial","fill":this.config.labelFontColor,"fill-opacity":"0"});this.txtLabel.id=this.config.id+"-txtlabel";this.txtMin=this.canvas.text(this.params.minX,this.params.minY,this.config.min);this.txtMin.attr({"font-size":this.params.minFontSize,"font-weight":"normal","font-family":"Arial","fill":this.config.labelFontColor,"fill-opacity":(this.config.showMinMax==true)?"1":"0"});this.txtMin.id=this.config.id+"-txtmin";this.txtMax=this.canvas.text(this.params.maxX,this.params.maxY,this.config.max);this.txtMax.attr({"font-size":this.params.maxFontSize,"font-weight":"normal","font-family":"Arial","fill":this.config.labelFontColor,"fill-opacity":(this.config.showMinMax==true)?"1":"0"});this.txtMax.id=this.config.id+"-txtmax";var defs=this.canvas.canvas.childNodes[1];var svg="http://www.w3.org/2000/svg";if(ie<9){onCreateElementNsReady(function(){this.generateShadow();});}else{this.generateShadow(svg,defs);}this.level.animate({pki:[this.config.value,this.config.min,this.config.max,this.params.widgetW,this.params.widgetH,this.params.dx,this.params.dy,this.config.gaugeWidthScale]},this.config.startAnimationTime,this.config.startAnimationType);this.txtValue.animate({"fill-opacity":"1"},this.config.startAnimationTime,this.config.startAnimationType);this.txtLabel.animate({"fill-opacity":"1"},this.config.startAnimationTime,this.config.startAnimationType);};JustGage.prototype.refresh=function(val){originalVal=val;if(val>this.config.max){val=this.config.max;}if(val<this.config.min){val=this.config.min;}var color=getColorForPercentage((val-this.config.min)/(this.config.max-this.config.min),this.config.levelColors,this.config.levelColorsGradient,this.config.fixedProgress,this.config.progressValues);this.canvas.getById(this.config.id+"-txtvalue").attr({"text":originalVal});this.canvas.getById(this.config.id+"-level").animate({pki:[val,this.config.min,this.config.max,this.params.widgetW,this.params.widgetH,this.params.dx,this.params.dy,this.config.gaugeWidthScale],"fill":color},this.config.refreshAnimationTime,this.config.refreshAnimationType);};var percentColors=["#a9d70b","#f9c802","#ff0000"]JustGage.prototype.generateShadow=function(svg,defs){var gaussFilter=document.createElementNS(svg,"filter");gaussFilter.setAttribute("id",this.config.id+"-inner-shadow");defs.appendChild(gaussFilter);var feOffset=document.createElementNS(svg,"feOffset");feOffset.setAttribute("dx",0);feOffset.setAttribute("dy",this.config.shadowVerticalOffset);gaussFilter.appendChild(feOffset);var feGaussianBlur=document.createElementNS(svg,"feGaussianBlur");feGaussianBlur.setAttribute("result","offset-blur");feGaussianBlur.setAttribute("stdDeviation",this.config.shadowSize);gaussFilter.appendChild(feGaussianBlur);var feComposite1=document.createElementNS(svg,"feComposite");feComposite1.setAttribute("operator","out");feComposite1.setAttribute("in","SourceGraphic");feComposite1.setAttribute("in2","offset-blur");feComposite1.setAttribute("result","inverse");gaussFilter.appendChild(feComposite1);var feFlood=document.createElementNS(svg,"feFlood");feFlood.setAttribute("flood-color","black");feFlood.setAttribute("flood-opacity",this.config.shadowOpacity);feFlood.setAttribute("result","color");gaussFilter.appendChild(feFlood);var feComposite2=document.createElementNS(svg,"feComposite");feComposite2.setAttribute("operator","in");feComposite2.setAttribute("in","color");feComposite2.setAttribute("in2","inverse");feComposite2.setAttribute("result","shadow");gaussFilter.appendChild(feComposite2);var feComposite3=document.createElementNS(svg,"feComposite");feComposite3.setAttribute("operator","over");feComposite3.setAttribute("in","shadow");feComposite3.setAttribute("in2","SourceGraphic");gaussFilter.appendChild(feComposite3);if(this.config.showInnerShadow==true){this.canvas.canvas.childNodes[2].setAttribute("filter","url(#"+this.config.id+"-inner-shadow)");this.canvas.canvas.childNodes[3].setAttribute("filter","url(#"+this.config.id+"-inner-shadow)");}}var getColorForPercentage=function(pct,col,grad,fix,val){var no=col.length;if(no===1)return col[0];var inc=(grad)?(1/(no-1)):(1/no);var colors=new Array();for(var i=0;i<col.length;i++){var percentage=(fix)?(val[i]):((grad)?(inc*i):(inc*(i+1)));var rval=parseInt((cutHex(col[i])).substring(0,2),16);var gval=parseInt((cutHex(col[i])).substring(2,4),16);var bval=parseInt((cutHex(col[i])).substring(4,6),16);colors[i]={pct:percentage,color:{r:rval,g:gval,b:bval}};}if(pct==0)return'rgb('+[colors[0].color.r,colors[0].color.g,colors[0].color.b].join(',')+')';for(var i=0;i<colors.length;i++){if(pct<=colors[i].pct){if(grad==true){var lower=colors[i-1];var upper=colors[i];var range=upper.pct-lower.pct;var rangePct=(pct-lower.pct)/range;var pctLower=1-rangePct;var pctUpper=rangePct;var color={r:Math.floor(lower.color.r*pctLower+upper.color.r*pctUpper),g:Math.floor(lower.color.g*pctLower+upper.color.g*pctUpper),b:Math.floor(lower.color.b*pctLower+upper.color.b*pctUpper)};return'rgb('+[color.r,color.g,color.b].join(',')+')';}else{return'rgb('+[colors[i].color.r,colors[i].color.g,colors[i].color.b].join(',')+')';}}}}function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}function cutHex(str){return(str.charAt(0)=="#")?str.substring(1,7):str}function getStyle(oElm,strCssRule){var strValue="";if(document.defaultView&&document.defaultView.getComputedStyle){strValue=document.defaultView.getComputedStyle(oElm,"").getPropertyValue(strCssRule);}else if(oElm.currentStyle){strCssRule=strCssRule.replace(/\-(\w)/g,function(strMatch,p1){return p1.toUpperCase();});strValue=oElm.currentStyle[strCssRule];}return strValue;}function onCreateElementNsReady(func){if(document.createElementNS!=undefined){func();}else{setTimeout(function(){onCreateElementNsReady(func);},100);}}var ie=(function(){var undef,v=3,div=document.createElement('div'),all=div.getElementsByTagName('i');while(div.innerHTML='<!--[if gt IE '+(++v)+']><i></i><![endif]-->',all[0]);return v>4?v:undef;}());